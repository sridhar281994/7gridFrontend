#:import dp kivy.metrics.dp
<UserMatchRV@RecycleView>:
    viewclass: "Label"

<WelcomeScreen>:
    name: 'welcome'

    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: 'assets/welcome.png'

        BoxLayout:
            orientation: 'vertical'
            size_hint: 0.85, None
            height: self.minimum_height
            spacing: dp(20)
            padding: dp(30)
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.5
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [20]

            Label:
                text: "Welcome to the Game!"
                font_size: min(self.width * 0.08, sp(28))
                color: 1, 1, 1, 1
                size_hint_y: None
                halign: "center"
                valign: "middle"
                text_size: self.width, None
                height: self.texture_size[1] + dp(20)

            Button:
                text: "Login"
                font_size: min(self.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(48)
                background_color: (0.2, 0.5, 1, 1)
                on_release: root.manager.current = 'login'

            Button:
                text: "Register"
                font_size: min(self.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(48)
                background_color: (0.3, 0.8, 0.3, 1)
                on_release: root.manager.current = 'register'

        Label:
            text: "© 2025 SRTech Games"
            font_size: min(self.width * 0.035, sp(14))
            color: 1, 1, 1, 0.7
            size_hint: None, None
            size: self.texture_size
            pos_hint: {"center_x": 0.5, "y": 0.02}

<LoginScreen>:
    name: "login"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/login.png"

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.85, 0.6
            pos_hint: {"center_x": 0.5, "center_y": 0.55}
            spacing: dp(15)
            padding: dp(20)
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.4
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [20]

            Label:
                text: "Login (OTP to Email)"
                font_size: sp(24)
                color: 1, 1, 1, 1
                halign: "center"
                valign: "middle"
                text_size: self.width, None
                size_hint_y: None
                height: self.texture_size[1] + dp(20)

            TextInput:
                id: phone_input
                hint_text: "Enter 10-digit Phone"
                input_filter: "int"
                max_text_length: 10
                multiline: False
                font_size: sp(18)
                size_hint_y: None
                height: dp(45)
                background_color: (1, 1, 1, 0.8)
                foreground_color: (0, 0, 0, 1)

            TextInput:
                id: otp_input
                hint_text: "Enter OTP (from your email)"
                multiline: False
                font_size: sp(18)
                size_hint_y: None
                height: dp(45)
                background_color: (1, 1, 1, 0.8)
                foreground_color: (0, 0, 0, 1)

            Button:
                text: "Send OTP"
                size_hint_y: None
                height: dp(45)
                font_size: sp(18)
                on_release: root.send_otp_to_user()

            Button:
                text: "Verify & Login"
                size_hint_y: None
                height: dp(45)
                font_size: sp(18)
                on_release: root.verify_and_login()

        Button:
            text: "Back"
            font_size: sp(18)
            size_hint: None, None
            size: dp(100), dp(45)
            pos_hint: {"x": 0.02, "y": 0.02}
            background_color: (0.2, 0.2, 0.2, 0.8)
            on_release: root.go_back()

<RegisterScreen>:
    name: "register"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/login.png"

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.85, None
            height: self.minimum_height
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)
            padding: dp(18)
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.45
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [20]

            Label:
                text: "Create your account"
                font_size: "26sp"
                color: 1, 1, 1, 1
                halign: "center"
                valign: "middle"
                text_size: self.width, None
                size_hint_y: None
                height: self.texture_size[1] + dp(12)

            TextInput:
                id: name_input
                hint_text: "Full Name"
                size_hint_y: None
                height: dp(48)
                font_size: "18sp"
                background_color: (1, 1, 1, 0.85)
                foreground_color: (0, 0, 0, 1)

            TextInput:
                id: phone_input
                hint_text: "Phone (10 digits)"
                input_filter: "int"
                max_text_length: 10
                size_hint_y: None
                height: dp(48)
                font_size: "18sp"
                background_color: (1, 1, 1, 0.85)
                foreground_color: (0, 0, 0, 1)

            TextInput:
                id: email_input
                hint_text: "Email"
                size_hint_y: None
                height: dp(48)
                font_size: "18sp"
                background_color: (1, 1, 1, 0.85)
                foreground_color: (0, 0, 0, 1)

            TextInput:
                id: password_input
                hint_text: "Password"
                password: True
                size_hint_y: None
                height: dp(48)
                font_size: "18sp"
                background_color: (1, 1, 1, 0.85)
                foreground_color: (0, 0, 0, 1)

            TextInput:
                id: upi_input
                hint_text: "UPI ID (optional)"
                size_hint_y: None
                height: dp(48)
                font_size: "18sp"
                background_color: (1, 1, 1, 0.85)
                foreground_color: (0, 0, 0, 1)

            BoxLayout:
                size_hint_y: None
                height: dp(48)
                spacing: dp(10)
                Button:
                    text: "Register"
                    font_size: "18sp"
                    background_color: (0.3, 0.7, 0.3, 1)
                    on_release: root.save_profile()

        Button:
            text: "Back"
            size_hint: None, None
            size: dp(90), dp(42)
            pos_hint: {"x": 0.02, "y": 0.02}
            background_color: (0.15, 0.15, 0.15, 0.8)
            font_size: "16sp"
            on_release: app.root.current = "welcome"


<SettingsScreen>:
    profile_image: root.profile_image

    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/common.png"

        ScrollView:
            size_hint: 1, 1
            do_scroll_y: True

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(10)
                padding: dp(15)

                Button:
                    size_hint: None, None
                    size: dp(90), dp(90)
                    pos_hint: {"center_x": 0.5}
                    background_normal: root.profile_image
                    background_down: root.profile_image
                    border: (0,0,0,0)
                    on_release: root.change_profile_picture()

                Label:
                    id: wallet_label
                    text: "Wallet: ₹0"
                    font_size: "17sp"
                    color: 0, 0.6, 0, 1
                    size_hint_y: None
                    height: dp(28)
                    halign: "center"
                    valign: "middle"
                    text_size: self.size

                TextInput:
                    id: name_input
                    hint_text: "Your Name"
                    font_size: "16sp"
                    size_hint_y: None
                    height: dp(42)
                    background_color: (1,1,1,0.8)
                    padding: dp(10)

                TextInput:
                    id: phone_input
                    hint_text: "Phone Number"
                    readonly: True
                    font_size: "16sp"
                    size_hint_y: None
                    height: dp(42)
                    background_color: (0.95,0.95,0.95,1)
                    padding: dp(10)

                TextInput:
                    id: desc_input
                    hint_text: "Description"
                    font_size: "16sp"
                    size_hint_y: None
                    height: dp(60)
                    background_color: (1,1,1,0.8)
                    padding: dp(10)

                TextInput:
                    id: upi_input
                    hint_text: "UPI ID"
                    font_size: "16sp"
                    size_hint_y: None
                    height: dp(42)
                    background_color: (1,1,1,0.8)
                    padding: dp(10)

                ToggleButton:
                    id: audio_toggle
                    text: "Sound ON" if root.music_playing else "Sound OFF"
                    font_size: "15sp"
                    size_hint_y: None
                    height: dp(40)
                    background_color: (0.2,0.6,1,0.9) if self.state == "down" else (0.7,0.7,0.7,0.9)
                    color: (1,1,1,1)
                    on_release:
                        root.toggle_audio()
                        self.text = "Sound ON" if root.music_playing else "Sound OFF"

                Button:
                    text: "Recharge"
                    size_hint_y: None
                    height: dp(40)
                    font_size: "15sp"
                    background_color: (0.9,0.6,0.1,1)
                    color: (1,1,1,1)
                    on_release: root.recharge()

                Button:
                    text: "Withdraw"
                    size_hint_y: None
                    height: dp(40)
                    font_size: "15sp"
                    background_color: (0.9,0.6,0.1,1)
                    color: (1,1,1,1)
                    on_release: root.withdraw()

                Button:
                    text: "Wallet History"
                    size_hint_y: None
                    height: dp(40)
                    font_size: "15sp"
                    background_color: (0.9,0.6,0.1,1)
                    color: (1,1,1,1)
                    on_release: root.show_wallet_history()

                Button:
                    text: "Save Settings"
                    size_hint_y: None
                    height: dp(40)
                    font_size: "15sp"
                    background_color: (0.2,0.7,0.2,1)
                    color: (1,1,1,1)
                    on_release: root.save_settings()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(38)
                    font_size: "15sp"
                    background_color: (0.7,0.2,0.2,1)
                    color: (1,1,1,1)
                    on_release: root.manager.current = "stage"

<StageScreen>:
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/common.png"

        # Top bar (profile + wallet)
        BoxLayout:
            orientation: "horizontal"
            size_hint: 1, None
            height: dp(55)
            padding: [dp(8), dp(8)]
            spacing: dp(8)
            pos_hint: {"top": 1}

            Image:
                id: profile_pic
                source: root.profile_image
                size_hint: None, None
                size: dp(45), dp(45)
                allow_stretch: True
                keep_ratio: True

            Label:
                id: welcome_label
                text: ""
                font_size: "16sp"
                color: 1, 1, 1, 1
                halign: "center"
                valign: "middle"
                text_size: self.size
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.5
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [8]

            Widget:

            Label:
                id: wallet_label
                text: "Wallet: ₹0"
                font_size: "16sp"
                color: 1, 1, 1, 1
                halign: "center"
                valign: "middle"
                text_size: self.size
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.5
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [8]

        # Stage selection box
        BoxLayout:
            orientation: "vertical"
            size_hint: 0.85, None
            height: dp(400)
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            spacing: dp(12)
            padding: dp(18)
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.45
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [20]

            Label:
                text: "Select Game Stage"
                font_size: "20sp"
                color: 1, 1, 1, 1
                size_hint_y: None
                height: dp(40)
                halign: "center"
                valign: "middle"
                text_size: self.size

            BoxLayout:
                id: stages_box
                orientation: "vertical"
                spacing: dp(10)
                size_hint: 1, 1

            BoxLayout:
                orientation: "horizontal"
                size_hint_y: None
                height: dp(45)
                spacing: dp(10)
                ToggleButton:
                    id: two_player_mode
                    text: "2 Player"
                    group: "mode"
                    state: "down"
                    font_size: "15sp"
                    on_release: app.selected_mode = 2

                ToggleButton:
                    id: three_player_mode
                    text: "3 Player"
                    group: "mode"
                    font_size: "15sp"
                    on_release: app.selected_mode = 3

        # Exit App Button (bottom-left)
        Button:
            text: "Exit App"
            size_hint: None, None
            size: dp(100), dp(40)
            pos_hint: {"x": 0.03, "y": 0.03}
            font_size: "14sp"
            background_color: 1, 0, 0, 0.8
            on_release: root.confirm_exit()

#:import dp kivy.metrics.dp
#:import sp kivy.metrics.sp

<UserMatchScreen>:
    name: "usermatch"

    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/common.png"

        # Player 1
        BoxLayout:
            id: p1_box
            orientation: "vertical"
            spacing: dp(4)
            size_hint: None, None
            size: dp(100), dp(120)
            pos_hint: {"center_x": 0.5, "top": 0.88}

            Image:
                id: p1_pic
                source: "assets/default.png"
                size_hint: None, None
                size: dp(90), dp(90)
                allow_stretch: True
                keep_ratio: True

            Label:
                id: p1_name
                text: root.player1_name
                font_size: sp(16)
                color: 1, 1, 1, 1
                halign: "center"
                valign: "middle"
                text_size: self.size

        Label:
            text: "VS"
            font_size: sp(20)
            color: 1, 1, 1, 1
            pos_hint: {"center_x": 0.5, "center_y": 0.64}

        # Player 2
        BoxLayout:
            id: p2_box
            orientation: "vertical"
            spacing: dp(4)
            size_hint: None, None
            size: dp(100), dp(120)
            pos_hint: {"center_x": 0.5, "center_y": 0.45 if root.selected_mode == 3 else 0.27}

            Image:
                id: p2_pic
                source: "assets/default.png"
                size_hint: None, None
                size: dp(90), dp(90)
                allow_stretch: True
                keep_ratio: True
                canvas.before:
                    PushMatrix
                    Rotate:
                        angle: root.p2_angle
                        origin: self.center
                canvas.after:
                    PopMatrix

            Label:
                id: p2_name
                text: root.player2_name
                font_size: sp(16)
                color: 1, 1, 1, 1
                halign: "center"
                valign: "middle"
                text_size: self.size

        Label:
            text: "VS"
            font_size: sp(20)
            color: 1, 1, 1, 1
            pos_hint: {"center_x": 0.5, "center_y": 0.28}
            opacity: 1 if root.selected_mode == 3 else 0

        # Player 3 (only for 3-player mode)
        BoxLayout:
            id: p3_box
            orientation: "vertical"
            spacing: dp(4)
            size_hint: None, None
            size: dp(100), dp(120)
            pos_hint: {"center_x": 0.5, "y": 0.05}
            opacity: 1 if root.selected_mode == 3 else 0
            disabled: False if root.selected_mode == 3 else True

            Image:
                id: p3_pic
                source: "assets/default.png"
                size_hint: None, None
                size: dp(90), dp(90)
                allow_stretch: True
                keep_ratio: True
                canvas.before:
                    PushMatrix
                    Rotate:
                        angle: root.p3_angle
                        origin: self.center
                canvas.after:
                    PopMatrix

            Label:
                id: p3_name
                text: root.player3_name
                font_size: sp(16)
                color: 1, 1, 1, 1
                halign: "center"
                valign: "middle"
                text_size: self.size

# -----------------------------
# Inline Popup for Free Play
# -----------------------------
<BotPromptPopup@Popup>:
    title: "No Match Found"
    size_hint: None, None
    size: dp(350), dp(220)
    auto_dismiss: False
    screen: None

    BoxLayout:
        orientation: "vertical"
        spacing: dp(12)
        padding: dp(16)

        Label:
            text: "No players found.\nDo you want to play with bots?"
            halign: "center"
            valign: "middle"
            color: 1,1,1,1
            text_size: self.width, None

        BoxLayout:
            orientation: "horizontal"
            spacing: dp(12)
            size_hint_y: None
            height: dp(48)

            Button:
                text: "Yes"
                on_release:
                    print("[DEBUG] Yes pressed")
                    root.dismiss()
                    root.screen._fallback_to_bots(root.screen.player1_name)

            Button:
                text: "No"
                on_release:
                    print("[DEBUG] No pressed")
                    root.dismiss()
                    root.screen.manager.current = "stage"

#:import dp kivy.metrics.dp
#:import sp kivy.metrics.sp

<ButtonImage@ButtonBehavior+Image>:
    allow_stretch: True
    keep_ratio: True

<DiceGameScreen>:
    name: "dicegame"

    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/game.png"

        # Player 1 (top-left)
        BoxLayout:
            orientation: 'horizontal'
            size_hint: None, None
            size: (root.width * 0.35), (root.height * 0.1)
            pos_hint: {"top": 0.98, "x": 0.02}
            spacing: dp(6)

            RelativeLayout:
                size_hint: None, None
                size: dp(55), dp(55)
                ButtonImage:
                    id: p1_pic
                    source: "assets/default.png"
                    on_release: root.show_player_info(0)
                Widget:
                    id: p1_overlay
                    size_hint: 1, 1
                    opacity: 0
                    canvas.before:
                        Color:
                            rgba: 1, 0, 0, self.opacity
                        Rectangle:
                            pos: self.pos
                            size: self.size

            Label:
                id: p1_name_label
                text: root.player1_name
                font_size: sp(15)
                color: 1, 1, 1, 1

        # Player 2 (top-right)
        BoxLayout:
            orientation: 'horizontal'
            size_hint: None, None
            size: (root.width * 0.35), (root.height * 0.1)
            pos_hint: {"top": 0.98, "right": 0.98}
            spacing: dp(6)

            Label:
                id: p2_name_label
                text: root.player2_name
                font_size: sp(15)
                color: 1, 1, 1, 1

            RelativeLayout:
                size_hint: None, None
                size: dp(55), dp(55)
                ButtonImage:
                    id: p2_pic
                    source: "assets/default.png"
                    on_release: root.show_player_info(1)
                Widget:
                    id: p2_overlay
                    size_hint: 1, 1
                    opacity: 0
                    canvas.before:
                        Color:
                            rgba: 1, 0, 0, self.opacity
                        Rectangle:
                            pos: self.pos
                            size: self.size

        # Player 3 (bottom-right)
        BoxLayout:
            orientation: 'horizontal'
            size_hint: None, None
            size: (root.width * 0.35), (root.height * 0.1)
            pos_hint: {"x": 0.65, "y": 0.08}  # slightly raised to make coin visible
            spacing: dp(6)
            opacity: 1 if root.player3_name and root._num_players == 3 else 0
            disabled: False if root.player3_name and root._num_players == 3 else True

            RelativeLayout:
                size_hint: None, None
                size: dp(55), dp(55)
                ButtonImage:
                    id: p3_pic
                    source: "assets/default.png"
                    on_release: root.show_player_info(2)
                Widget:
                    id: p3_overlay
                    size_hint: 1, 1
                    opacity: 0
                    canvas.before:
                        Color:
                            rgba: 1, 0, 0, self.opacity
                        Rectangle:
                            pos: self.pos
                            size: self.size

            Label:
                id: p3_name_label
                text: root.player3_name
                font_size: sp(15)
                color: 1, 1, 1, 1

        # Stage label
        Label:
            id: stage_label
            text: root.stage_label
            font_size: sp(18)
            color: 1, 1, 1, 1
            pos_hint: {"top": 0.93, "center_x": 0.5}

        # Dice (bottom-left)
        AnchorLayout:
            anchor_x: "left"
            anchor_y: "bottom"
            size_hint: None, None
            size: dp(100), dp(100)
            pos_hint: {"x": 0.03, "y": 0.03}

            PolygonDice:
                id: dice_button
                size_hint: None, None
                size: dp(80), dp(80)
                on_release: root.roll_dice()

        # Board
        AnchorLayout:
            anchor_x: "center"
            anchor_y: "center"
            size_hint: 1, 1

            BoxLayout:
                orientation: 'vertical'
                size_hint: (0.45 if root.width > root.height else 0.35), 0.75
                padding: dp(10)
                spacing: dp(4)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.4
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [dp(14)]

                GridLayout:
                    id: board
                    cols: 1
                    rows: 8
                    size_hint_y: 1
                    row_force_default: True
                    on_size: self.row_default_height = self.height / 8

                    Label:
                        id: box_0
                        text: "Start"
                        color: 1, 1, 1, 1
                        canvas.before:
                            Color:
                                rgba: 0.4, 0.2, 0.1, 1
                            Rectangle:
                                pos: self.pos
                                size: self.size

                    Label:
                        id: box_1
                        text: ""
                        canvas.before:
                            Color:
                                rgba: 0, 0, 0, 0.1
                            Rectangle:
                                pos: self.pos
                                size: self.size

                    Label:
                        id: box_2
                        text: ""
                        canvas.before:
                            Color:
                                rgba: 1, 1, 1, 0.2
                            Rectangle:
                                pos: self.pos
                                size: self.size

                    RelativeLayout:
                        id: box_3
                        canvas.before:
                            Color:
                                rgba: 0, 0, 0, 0.1
                            Rectangle:
                                pos: self.pos
                                size: self.size
                        Image:
                            source: "assets/danger.png"
                            allow_stretch: True
                            keep_ratio: True

                    Label:
                        id: box_4
                        text: ""
                        canvas.before:
                            Color:
                                rgba: 1, 1, 1, 0.2
                            Rectangle:
                                pos: self.pos
                                size: self.size

                    Label:
                        id: box_5
                        text: ""
                        canvas.before:
                            Color:
                                rgba: 0, 0, 0, 0.1
                            Rectangle:
                                pos: self.pos
                                size: self.size

                    Label:
                        id: box_6
                        text: ""
                        canvas.before:
                            Color:
                                rgba: 1, 1, 1, 0.2
                            Rectangle:
                                pos: self.pos
                                size: self.size

                    RelativeLayout:
                        id: box_7
                        Image:
                            source: "assets/final.png"
                            allow_stretch: True
                            keep_ratio: True

        # Coin layer
        FloatLayout:
            id: coin_layer
            size_hint: 1, 1

        # Exit button
        Button:
            text: "GIVE UP"
            size_hint: None, None
            size: dp(100), dp(38)
            pos_hint: {"center_x": 0.5, "y": 0.02}
            background_color: (1, 0, 0, 0.8)
            on_release: root.force_player_exit()
